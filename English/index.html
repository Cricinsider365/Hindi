<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Shaka Player Full Working Example</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.5/shaka-player.compiled.js"></script>
  <style>
    .shaka-video-container {
      position: relative;
      width: 100%;
      height: 100vh;
      background-color: black;
    }
    video {
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <div class="shaka-video-container">
    <video></video>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      // Install shaka polyfills
      shaka.polyfill.installAll();

      if (!shaka.Player.isBrowserSupported()) {
        console.error('Browser not supported');
        return;
      }

      const video = document.querySelector('video');
      const player = new shaka.Player(video);

      const container = document.querySelector('.shaka-video-container');
      const ui = new shaka.ui.Overlay(player, container, video);
      
      // UI config
      ui.configure({
        seekBarColors: {
          base: 'rgba(255,255,255,.2)',
          buffered: 'rgba(255,255,255,.4)',
          played: 'rgb(255,0,0)',
        },
        controlPanelElements: [
          'play_pause',
          'time_and_duration',
          'mute',
          'volume',
          'spacer',
          'captions',
          'quality',
          'language',
          'picture_in_picture',
          'fullscreen',
        ]
      });

      // Player config
      player.configure({
        drm: {
          clearKeys: {
            "df20894ec30954d3b28097c138f4cfda": "ff9b6292b1cddbd11a046029cb314634"
          }
        },
        streaming: {
          bufferingGoal: 30,
          rebufferingGoal: 5,
          bufferBehind: 30,
          retryParameters: {
            timeout: 15000,
            maxAttempts: 3,
            baseDelay: 500,
            backoffFactor: 1.5
          },
          segmentRequestTimeout: 10000,
          useNativeHlsOnSafari: true
        },
        manifest: {
          retryParameters: {
            timeout: 10000,
            maxAttempts: 2
          }
        }
      });

      // Add custom request filter (headers injection)
      player.getNetworkingEngine().registerRequestFilter((type, request) => {
        request.headers['Referer'] = 'https://www.jiotv.com/';
        request.headers['User-Agent'] = "plaYtv/7.1.5 (Linux;Android 13) ExoPlayerLib/2.11.6 ";
        request.headers['Cookie'] = "__hdnea__=st=1750764110~exp=1750850510~acl=/*~hmac=1678d02bfae7cb31acec2f80540b3bfdf200e1f475bc7e5e2e6ab28ab1246520";

        if ((type === shaka.net.NetworkingEngine.RequestType.MANIFEST ||
            type === shaka.net.NetworkingEngine.RequestType.SEGMENT) && 
            request.uris[0].indexOf('__hdnea__=') === -1) {
          const separator = request.uris[0].includes('?') ? '&' : '?';
          request.uris[0] += separator + '__hdnea__=st=1750764110~exp=1750850510~acl=/*~hmac=1678d02bfae7cb31acec2f80540b3bfdf200e1f475bc7e5e2e6ab28ab1246520';
        }
      });

      player.addEventListener('error', (event) => {
        console.error('Shaka Player Error:', event.detail);
      });

      // Load stream
      try {
        await player.load("https://jiotvmblive.cdn.jio.com/bpk-tv/Star_Sports_1_BTS/output/index.mpd");
        console.log('The video has been loaded successfully.');
        await tryAutoplay(video, container);
      } catch (error) {
        console.error('Error loading stream:', error);
      }
    });

    // Autoplay helper function
    async function tryAutoplay(video, container) {
      const autoplayStrategies = [
        async () => { video.muted = true; await video.play(); return true; },
        async () => { video.muted = true; await delay(200); await video.play(); return true; },
        async () => { video.muted = false; await video.play(); return true; }
      ];

      for (let i = 0; i < autoplayStrategies.length; i++) {
        try {
          await autoplayStrategies[i]();
          console.log(`Autoplay success with strategy ${i + 1}`);
          return true;
        } catch (err) {
          console.log(`Autoplay strategy ${i + 1} failed: ${err.message}`);
        }
      }

      showPlayButton(video, container);
      return false;
    }

    function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    function showPlayButton(video, container) {
      const button = document.createElement('div');
      button.innerHTML = `
        <div style="
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: rgba(0,0,0,0.8);
          color: white;
          padding: 15px 30px;
          border-radius: 8px;
          cursor: pointer;
          font-size: 18px;
          border: 2px solid #f00;
          z-index: 1000;">
          â–¶ Click to Play
        </div>
      `;
      container.appendChild(button);
      button.addEventListener('click', async () => {
        try {
          video.muted = false;
          await video.play();
          button.remove();
        } catch (err) {
          console.error("Manual play failed:", err);
        }
      });
    }
  </script>
</body>
</html>